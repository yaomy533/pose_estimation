#!/usr/bin/env python 
# -*- coding: utf-8 -*-
# @Time    : 2022/1/3 17:33
# @Author  : yaomy

from datasets.cleargrasp.dataset import BathPoseDataset
import torch
from pathlib import Path
import torch.distributed
import torch.utils.data
import torch.multiprocessing as mp


class Dataset(BathPoseDataset):
    def __init__(self):
        super(Dataset, self).__init__('train', 1000, True, '/root/Source/ymy_dataset/cleargrasp', 0., False)

    def __getitem__(self, index):
        cc = torch.tensor([0.])
        path = [self._datalist_input[index]]
        return cc, path


def main_worker(gpu):
    torch.distributed.init_process_group(
        backend='nccl',
        init_method='tcp://127.0.0.1:23456',
        world_size=2,
        rank=gpu,
    )

    dataset = Dataset()
    sampler = torch.utils.data.distributed.DistributedSampler(dataset, shuffle=True)
    dataloader = torch.utils.data.DataLoader(
        dataset,
        batch_size=8,
        shuffle=False,
        num_workers=10,
        sampler=sampler
    )

    epoch_summary = {
        'cup': 0,
        'flower': 0,
        'heart': 0,
        'square': 0,
        'stemless': 0,
    }

    for epoch in range(0, 50):
        print(epoch)
        summary = {
            'cup': 0,
            'flower': 0,
            'heart': 0,
            'square': 0,
            'stemless': 0,
        }
        sampler.set_epoch(epoch)
        for item, ds in enumerate(dataloader, 0):
            _, paths = ds
            for p in paths[0]:
                for k in summary.keys():
                    if k in p:
                        summary[k] += 1
            # if item >= 5000:
            #     epoch_summary = {key: epoch_summary[key]+summary[key] for key in summary.keys()}
            #     print(epoch_summary)
            #     break
        epoch_summary = {key: epoch_summary[key] + summary[key] for key in summary.keys()}
        print(epoch_summary)
    epoch_summary = {key: epoch_summary[key]/(epoch+1) for key in epoch_summary.keys()}
    print(epoch_summary)


def dataset_statistics():
    """统计每个dataset原始的大小
    """
    from datasets.cleargrasp.dataset import PoseDataset
    from torch.utils.data import DataLoader

    torch.multiprocessing.set_sharing_strategy('file_system')
    dataset_root = '/root/Source/ymy_dataset/cleargrasp'
    noise_trans = 0.02
    dataset = PoseDataset('train', 1000, True, dataset_root, noise_trans, False, max_img=1921)
    dataloader = DataLoader(dataset, num_workers=10, shuffle=True)
    obj_name = {
        0: 'cup',
        1: 'flower',
        2: 'heart',
        3: 'square',
        4: 'stemless',
    }

    size_sum = {
        'cup': {},
        'flower': {},
        'heart': {},
        'square': {},
        'stemless': {},
    }

    for i, datas in enumerate(dataloader, 0):
        if not datas['flag'].item():
            continue
        for index in range(len(datas['img_cropeds'])):
            print(i)
            img = datas['img_cropeds'][index]
            _, _, h, w = img.shape
            if str(f'{h},{w}') in size_sum[obj_name[int(datas['obj_ids'][index].item())]]:
                size_sum[obj_name[int(datas['obj_ids'][index].item())]][str(f'{h},{w}')] += 1
            else:
                size_sum[obj_name[int(datas['obj_ids'][index].item())]][str(f'{h},{w}')] = 0

    print(size_sum)


def statis_size():

    sizes = {
        'cup': {'200,360': 101, '240,400': 129, '160,400': 23, '360,160': 23, '120,120': 234, '160,200': 454, '120,160': 481, '160,160': 425, '200,320': 253, '240,200': 337, '280,160': 309, '200,200': 381, '280,240': 243, '240,320': 205, '400,360': 65, '280,360': 128, '240,240': 257, '280,200': 316, '400,680': 3, '160,760': 1, '200,280': 343, '200,120': 564, '120,240': 119, '240,280': 255, '320,240': 165, '160,80': 202, '160,320': 69, '160,280': 233, '200,240': 338, '240,160': 447, '240,360': 169, '400,640': 6, '280,280': 195, '400,400': 57, '240,520': 10, '360,200': 170, '400,280': 110, '360,520': 25, '200,480': 17, '480,440': 15, '560,400': 15, '200,160': 484, '320,440': 56, '320,280': 157, '360,320': 98, '320,360': 107, '160,120': 605, '120,440': 8, '480,320': 46, '360,240': 174, '400,320': 82, '440,240': 66, '400,440': 33, '360,560': 16, '280,520': 15, '560,440': 5, '400,200': 56, '360,360': 75, '120,200': 424, '240,120': 186, '240,440': 42, '440,320': 63, '280,120': 14, '160,240': 419, '360,280': 134, '320,200': 306, '320,160': 125, '120,400': 9, '360,400': 83, '440,360': 45, '640,520': 3, '560,640': 0, '160,360': 32, '80,320': 7, '80,160': 87, '80,120': 104, '320,400': 78, '280,560': 8, '440,400': 44, '440,280': 76, '320,320': 116, '200,400': 37, '360,480': 34, '120,320': 27, '280,440': 87, '120,80': 128, '400,240': 148, '280,400': 106, '320,520': 33, '360,440': 41, '400,480': 27, '600,360': 9, '480,640': 5, '480,240': 27, '560,280': 10, '80,80': 23, '280,320': 161, '480,400': 30, '320,600': 5, '80,200': 46, '80,280': 23, '120,280': 50, '520,320': 26, '520,440': 6, '200,440': 21, '400,560': 13, '240,480': 22, '320,480': 55, '680,400': 7, '480,360': 31, '560,320': 14, '440,200': 9, '440,640': 2, '440,520': 17, '280,480': 47, '440,560': 14, '200,80': 11, '80,240': 39, '280,720': 1, '400,520': 20, '160,480': 9, '440,600': 5, '640,360': 4, '280,1000': 0, '520,960': 0, '480,280': 46, '360,600': 13, '320,560': 14, '600,440': 11, '560,600': 0, '40,240': 4, '440,480': 9, '520,280': 24, '720,480': 3, '80,600': 0, '640,320': 6, '560,480': 2, '680,360': 3, '200,520': 6, '80,480': 2, '600,400': 5, '320,120': 4, '560,360': 16, '280,640': 3, '200,560': 6, '440,440': 29, '480,600': 8, '520,480': 13, '360,720': 1, '360,680': 2, '480,680': 1, '480,480': 20, '680,480': 1, '80,400': 2, '280,880': 0, '280,600': 4, '760,520': 0, '800,680': 0, '160,440': 10, '520,360': 16, '760,440': 0, '720,520': 1, '120,480': 4, '640,400': 6, '680,520': 1, '40,80': 4, '600,520': 5, '160,600': 1, '520,560': 4, '40,40': 3, '320,640': 1, '120,520': 0, '640,560': 3, '240,600': 4, '560,680': 3, '240,560': 6, '560,560': 1, '720,880': 0, '640,440': 3, '320,720': 0, '400,760': 0, '240,720': 1, '80,360': 8, '240,680': 0, '520,400': 17, '520,760': 0, '600,480': 2, '320,800': 2, '480,560': 11, '120,360': 15, '560,520': 3, '280,800': 0, '520,520': 3, '160,560': 3, '880,480': 1, '40,160': 0, '520,240': 4, '400,600': 4, '600,320': 6, '520,600': 1, '360,640': 2, '440,760': 1, '120,720': 0, '40,120': 2, '720,320': 0, '200,640': 2, '80,440': 3, '24,680': 0, '680,440': 3, '520,680': 4, '280,680': 0, '440,720': 1, '480,520': 4, '40,280': 1, '400,160': 1, '720,440': 0, '600,680': 0, '760,360': 1, '400,920': 0, '360,80': 0, '760,480': 0, '40,200': 0, '160,520': 1, '24,440': 0, '640,640': 0, '320,760': 0, '360,1000': 0, '760,400': 0, '200,720': 0, '720,400': 0, '600,600': 1, '360,800': 0, '880,640': 0, '760,600': 0, '160,640': 0, '840,520': 0, '240,640': 0, '320,880': 0, '280,80': 0, '440,120': 0, '560,720': 0, '640,480': 0, '640,680': 1, '480,800': 0, '680,720': 0, '520,720': 1, '440,1000': 0, '640,720': 0, '160,680': 1, '120,560': 0, '600,720': 0, '120,40': 0, '160,720': 0, '400,800': 0, '440,680': 0, '600,560': 0, '120,800': 0, '320,680': 0, '840,640': 0, '680,560': 0, '760,560': 0, '200,600': 0, '400,720': 0},
        'flower': {'240,120': 35, '240,240': 309, '280,280': 90, '120,160': 2085, '200,160': 158, '160,200': 1565, '200,240': 686, '120,280': 108, '160,160': 2366, '80,160': 272, '160,120': 245, '80,280': 28, '200,320': 62, '120,240': 186, '200,200': 925, '160,240': 277, '120,120': 2509, '120,80': 153, '80,120': 822, '280,360': 22, '120,200': 343, '80,200': 182, '80,240': 71, '160,280': 105, '80,80': 237, '240,280': 242, '120,320': 37, '200,360': 28, '280,400': 5, '200,280': 163, '240,160': 61, '160,80': 93, '200,80': 24, '160,320': 56, '320,200': 1, '280,120': 3, '320,360': 16, '200,120': 91, '280,200': 20, '320,280': 3, '280,240': 27, '240,320': 49, '320,320': 15, '160,360': 25, '40,120': 33, '280,320': 72, '280,80': 1, '240,200': 71, '120,440': 0, '240,400': 9, '320,400': 4, '360,440': 3, '200,400': 8, '160,440': 6, '240,360': 22, '320,240': 1, '200,440': 3, '40,80': 17, '40,160': 15, '120,400': 1, '440,360': 0, '80,320': 4, '120,40': 9, '40,240': 1, '160,480': 2, '360,160': 0, '40,200': 6, '120,360': 17, '280,160': 11, '40,40': 5, '80,40': 6, '280,520': 0, '240,440': 6, '400,560': 0, '240,80': 2, '360,400': 4, '400,240': 0, '120,520': 0, '280,440': 0, '160,400': 4, '200,480': 3, '360,360': 3, '280,480': 0, '360,280': 2, '200,520': 0, '400,440': 1, '320,160': 3, '240,480': 0, '320,440': 0, '160,520': 0, '40,360': 0, '360,480': 0, '40,280': 0, '80,360': 0, '360,320': 0},
        'heart': {'240,240': 3460, '120,120': 5692, '120,160': 2218, '160,120': 744, '200,240': 1590, '280,200': 90, '280,240': 296, '200,200': 6256, '160,160': 8628, '120,80': 170, '160,200': 2307, '160,240': 179, '280,280': 1551, '200,120': 172, '240,280': 977, '80,120': 415, '240,360': 69, '360,280': 17, '320,360': 166, '280,320': 476, '360,360': 158, '200,160': 653, '160,280': 161, '240,160': 167, '200,280': 211, '280,160': 29, '360,320': 51, '320,320': 536, '80,80': 202, '240,200': 508, '200,320': 126, '200,360': 79, '160,360': 59, '120,240': 85, '80,200': 23, '120,200': 93, '360,400': 57, '320,440': 15, '320,400': 33, '280,360': 95, '320,240': 41, '240,320': 169, '160,400': 21, '120,320': 79, '360,440': 7, '400,400': 25, '400,280': 1, '320,280': 143, '280,440': 12, '160,320': 100, '200,440': 12, '280,400': 45, '160,440': 4, '120,360': 20, '120,280': 89, '200,400': 29, '120,400': 6, '360,240': 12, '280,480': 3, '360,200': 2, '160,80': 52, '240,400': 42, '320,200': 18, '80,240': 20, '400,480': 0, '240,120': 13, '80,160': 19, '80,280': 21, '320,480': 0, '40,120': 7, '400,360': 14, '200,80': 0, '400,440': 2, '80,440': 0, '40,80': 1, '440,360': 0, '80,360': 3, '360,480': 0, '400,320': 4, '160,480': 0, '80,320': 5, '80,400': 0, '240,480': 2, '40,160': 1, '120,480': 0, '200,480': 1, '440,440': 0, '240,440': 9, '80,40': 0, '440,400': 1, '120,440': 0, '320,160': 0},
        'square': {'120,160': 1767, '200,160': 1605, '120,200': 1845, '160,80': 1446, '200,120': 2531, '120,120': 1119, '120,240': 888, '200,240': 869, '280,320': 259, '240,160': 1569, '280,160': 1164, '240,240': 541, '200,320': 472, '160,160': 1587, '240,360': 270, '320,200': 610, '240,200': 783, '80,160': 669, '160,120': 2418, '160,240': 1229, '200,200': 1031, '360,280': 187, '280,280': 291, '120,320': 58, '240,280': 444, '160,280': 816, '320,160': 510, '320,120': 9, '240,120': 1179, '80,200': 205, '120,80': 826, '360,240': 330, '360,320': 122, '200,400': 169, '320,400': 91, '160,200': 1584, '80,120': 284, '280,200': 746, '240,400': 173, '120,280': 197, '640,400': 4, '320,280': 235, '160,360': 127, '160,400': 31, '320,320': 168, '200,80': 285, '160,320': 365, '320,240': 387, '280,360': 198, '440,360': 42, '240,320': 335, '520,400': 15, '520,360': 23, '400,320': 93, '320,360': 124, '280,240': 426, '360,200': 364, '680,480': 0, '200,280': 653, '320,480': 30, '440,200': 36, '480,280': 72, '400,280': 148, '200,360': 313, '400,200': 155, '440,280': 110, '480,400': 26, '280,120': 217, '440,240': 122, '560,320': 18, '360,560': 7, '400,520': 7, '240,520': 15, '160,440': 13, '600,280': 2, '640,480': 3, '400,360': 62, '280,400': 130, '360,160': 100, '240,480': 56, '480,360': 21, '480,240': 44, '400,240': 204, '400,400': 28, '320,440': 50, '560,480': 3, '360,400': 63, '280,440': 91, '400,440': 24, '280,480': 49, '360,440': 36, '80,360': 9, '200,440': 56, '360,360': 85, '440,320': 69, '200,520': 10, '560,400': 14, '520,320': 28, '520,280': 38, '480,320': 34, '280,520': 32, '440,480': 9, '360,520': 15, '360,480': 27, '440,400': 32, '320,520': 30, '120,480': 5, '240,440': 89, '200,560': 1, '480,480': 3, '560,440': 7, '200,640': 2, '520,440': 9, '80,80': 74, '280,600': 3, '480,200': 3, '80,240': 41, '80,320': 9, '480,440': 8, '440,440': 15, '120,360': 21, '480,560': 3, '400,480': 11, '600,440': 8, '160,520': 5, '40,240': 0, '120,400': 12, '40,160': 5, '80,440': 1, '320,640': 3, '80,640': 0, '480,520': 1, '600,320': 10, '600,400': 2, '520,480': 2, '80,480': 3, '320,560': 6, '440,560': 1, '680,440': 1, '560,280': 9, '200,480': 15, '680,360': 2, '760,320': 0, '160,480': 12, '560,240': 1, '160,560': 3, '520,600': 0, '560,360': 8, '120,440': 8, '280,560': 10, '400,720': 0, '320,600': 5, '400,160': 8, '720,480': 0, '240,560': 10, '600,360': 8, '40,200': 4, '80,280': 11, '120,600': 1, '120,520': 6, '440,680': 1, '160,600': 2, '520,240': 12, '520,520': 2, '600,480': 2, '360,600': 2, '440,600': 0, '640,440': 2, '280,640': 3, '400,560': 6, '320,680': 0, '520,560': 1, '560,560': 0, '440,520': 3, '240,80': 0, '360,640': 0, '520,640': 0, '400,600': 0, '640,360': 3, '640,280': 0, '560,520': 0, '480,640': 0, '360,720': 1, '560,600': 0, '480,600': 0, '320,720': 1, '120,560': 3, '40,280': 0, '640,320': 0, '360,120': 1, '680,600': 0, '400,640': 0, '200,600': 0, '720,400': 0, '240,640': 0, '240,600': 0, '80,400': 0, '760,480': 0, '600,600': 0, '240,720': 0},
        'stemless': {'80,80': 515, '80,40': 155, '40,80': 71, '160,120': 2344, '200,120': 2843, '240,120': 1366, '80,240': 89, '160,240': 900, '120,200': 1848, '120,240': 1124, '160,160': 1275, '320,240': 241, '80,160': 1225, '120,160': 1568, '160,80': 2002, '200,600': 1, '440,240': 133, '240,240': 425, '120,280': 392, '280,200': 528, '200,280': 445, '160,320': 442, '360,240': 202, '320,160': 567, '120,120': 1286, '120,80': 1897, '200,160': 1144, '160,200': 1128, '400,200': 186, '160,360': 193, '280,160': 1239, '160,280': 748, '360,200': 426, '160,440': 11, '200,320': 337, '280,360': 133, '280,280': 231, '360,160': 93, '240,200': 632, '240,160': 1388, '200,360': 253, '360,280': 108, '600,360': 10, '240,400': 126, '560,440': 6, '280,120': 225, '200,80': 229, '360,360': 55, '320,360': 82, '80,120': 1165, '240,280': 316, '400,280': 101, '280,440': 59, '200,200': 781, '320,200': 601, '400,240': 186, '320,280': 171, '400,320': 47, '280,240': 333, '200,400': 147, '360,320': 86, '200,240': 652, '440,280': 66, '480,360': 15, '240,320': 190, '280,520': 19, '400,480': 18, '480,280': 71, '400,360': 41, '40,120': 51, '280,320': 168, '80,200': 518, '400,440': 15, '120,320': 63, '80,320': 18, '240,480': 43, '40,160': 14, '320,320': 108, '280,400': 74, '200,440': 85, '560,280': 19, '240,440': 62, '480,240': 58, '520,440': 4, '440,480': 5, '440,360': 31, '120,440': 11, '320,440': 46, '520,240': 12, '320,480': 26, '600,480': 1, '520,320': 33, '400,400': 28, '520,280': 50, '440,320': 26, '240,360': 168, '360,400': 44, '120,40': 30, '80,280': 43, '80,440': 5, '480,320': 31, '520,360': 20, '240,520': 21, '440,200': 33, '320,400': 65, '480,480': 4, '320,640': 4, '360,440': 26, '360,480': 13, '520,400': 12, '40,200': 20, '120,480': 8, '320,520': 8, '440,440': 13, '160,400': 37, '600,320': 13, '320,560': 5, '280,480': 35, '280,560': 19, '600,400': 3, '280,640': 0, '600,280': 3, '560,400': 5, '520,480': 4, '560,360': 14, '200,480': 16, '200,560': 8, '80,360': 10, '360,520': 7, '640,440': 0, '680,480': 1, '440,520': 5, '400,160': 4, '600,440': 1, '480,520': 1, '680,440': 1, '560,240': 1, '480,440': 6, '320,120': 3, '360,600': 2, '440,560': 3, '360,640': 3, '560,320': 14, '120,360': 23, '400,520': 7, '40,320': 0, '560,520': 0, '320,600': 1, '120,400': 11, '440,400': 11, '160,480': 5, '360,560': 1, '280,600': 5, '320,680': 1, '480,400': 13, '480,200': 3, '640,320': 4, '120,520': 6, '80,560': 1, '120,680': 1, '240,600': 4, '440,760': 0, '240,560': 5, '560,560': 0, '80,400': 5, '40,280': 2, '400,800': 1, '640,360': 3, '560,480': 1, '360,680': 0, '680,400': 0, '200,520': 8, '680,360': 2, '320,800': 0, '160,600': 4, '120,560': 2, '360,720': 0, '400,560': 1, '400,600': 0, '720,440': 0, '160,560': 1, '40,240': 4, '480,560': 1, '160,520': 6, '320,720': 0, '520,640': 1, '640,640': 0, '200,720': 0, '320,80': 0, '400,680': 0, '720,360': 0, '160,680': 1, '440,120': 0, '40,400': 0, '400,760': 0, '760,400': 0, '200,880': 0, '520,600': 0, '120,640': 0, '480,640': 1, '640,400': 0, '520,520': 1, '240,640': 0, '160,640': 0, '440,680': 0, '240,680': 0}
    }
    new_sizes = {
        'cup': {},
        'flower': {},
        'heart': {},
        'square': {},
        'stemless': {},
    }

    for key, size in sizes.items():
        for k, v in size.items():
            s = max(int(i) for i in k.split(','))
            if s not in new_sizes[key]:
                new_sizes[key][s] = v+1
            else:
                new_sizes[key][s] += v + 1

    for key, value in new_sizes.items():
        all = sum(value.values())
        print(key, all)
        nn = sorted(value.items(),  key=lambda d: d[1], reverse=True)
        print({kv[0]: float(kv[1])/float(all) for kv in nn[:10]})


if __name__ == '__main__':
    statis_size()
